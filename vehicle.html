<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부경대학교 탄소발자국 대시보드 - 차량</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        .sidebar {
            height: 100vh;
            width: 280px;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #1f2937;
            overflow-x: hidden;
            padding-top: 20px;
        }
        
        .main-content {
            margin-left: 280px;
            padding: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }

        .summary-cards {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 24%;
            display: flex;
            align-items: center;
        }
        
        .summary-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .green-icon {
            background-color: #4ade80;
        }
        
        .blue-icon {
            background-color: #3b82f6;
        }
        
        .red-icon {
            background-color: #ef4444;
        }

        .yellow-icon {
            background-color: #f59e0b;
        }
        
        .summary-text h3 {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .summary-text p {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- 로딩 스피너 -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- 사이드바 -->
    <div class="sidebar text-white">
        <div class="px-6 py-4">
            <h1 class="text-xl font-bold">부경대학교</h1>
            <p class="text-sm opacity-80">탄소발자국 대시보드</p>
        </div>
        <div class="mt-10">
            <ul>
                <li class="px-6 py-3 hover:bg-gray-700">
                    <a href="/" class="flex items-center">
                        <i class="fas fa-home mr-3"></i>
                        <span>홈</span>
                    </a>
                </li>
                <li class="px-6 py-3 bg-red-600">
                    <a href="/vehicle" class="flex items-center">
                        <i class="fas fa-car mr-3"></i>
                        <span>차량</span>
                    </a>
                </li>
                <li class="px-6 py-3 hover:bg-gray-700">
                    <a href="/waste" class="flex items-center">
                        <i class="fas fa-trash mr-3"></i>
                        <span>폐기물</span>
                    </a>
                </li>
                <li class="px-6 py-3 hover:bg-gray-700">
                    <a href="/water" class="flex items-center">
                        <i class="fas fa-tint mr-3"></i>
                        <span>물</span>
                    </a>
                </li>
                <li class="px-6 py-3 hover:bg-gray-700">
                    <a href="/greenery" class="flex items-center">
                        <i class="fas fa-tree mr-3"></i>
                        <span>녹지</span>
                    </a>
                </li>
                <li class="px-6 py-3 hover:bg-gray-700">
                    <a href="/power" class="flex items-center">
                        <i class="fas fa-bolt mr-3"></i>
                        <span>전력</span>
                    </a>
                </li>
                <li class="px-6 py-3 hover:bg-gray-700">
                    <a href="/macc" class="flex items-center">
                        <i class="fas fa-chart-line mr-3"></i>
                        <span>MACC</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
        <!-- 헤더 -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">차량</h1>
            <div class="flex items-center">
                <div class="relative mr-4">
                    <select id="yearSelector" class="bg-white border rounded-md px-4 py-2 pr-8 appearance-none focus:outline-none">
                        <option value="2025">2025년</option>
                        <option value="2024">2024년</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>새로고침
                </button>
            </div>
        </div>

        <!-- 에러 메시지 -->
        <div id="errorMessage" class="error-message">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span id="errorText"></span>
        </div>

        <!-- 요약 정보 카드 -->
        <div class="summary-section mb-6">
            <p class="text-gray-500 mb-2">Summary</p>
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-icon green-icon">
                        <i class="fas fa-car text-white"></i>
                    </div>
                    <div class="summary-text">
                        <h3>한달 차량 대수</h3>
                        <p id="totalVehicles">-999</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon blue-icon">
                        <i class="fas fa-calendar-day text-white"></i>
                    </div>
                    <div class="summary-text">
                        <h3>총 차량 일간 탄소 배출량</h3>
                        <p id="dailyEmissions">- tCO₂eq</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon red-icon">
                        <i class="fas fa-calendar-alt text-white"></i>
                    </div>
                    <div class="summary-text">
                        <h3>총 차량 월간 탄소 배출량</h3>
                        <p id="monthlyEmissions">- tCO₂eq</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-icon yellow-icon">
                        <i class="fas fa-bus text-white"></i>
                    </div>
                    <div class="summary-text">
                        <h3>셔틀버스 부문 탄소 배출량</h3>
                        <p id="shuttleEmissions">- tCO₂eq</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 차트 컨테이너 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- 일별 탄소 배출량 추이 -->
            <div class="card">
                <h3 class="text-lg font-semibold mb-4">일별 탄소 배출량 추이</h3>
                <div class="h-64">
                    <canvas id="dailyEmissionsChart"></canvas>
                </div>
            </div>
            
            <!-- 월별 탄소 배출량 추이 -->
            <div class="card">
                <h3 class="text-lg font-semibold mb-4">월별 탄소 배출량 추이</h3>
                <div class="h-64">
                    <canvas id="monthlyEmissionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 두 번째 차트 행 -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <!-- 일별 차량 연료별 탄소 배출량 -->
            <div class="card">
                <h3 class="text-lg font-semibold mb-4">일별 차량 연료별 탄소 배출량</h3>
                <div class="h-80">
                    <canvas id="dailyFuelEmissionsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dailyEmissionsChart, monthlyEmissionsChart, dailyFuelEmissionsChart;

        function initCharts() {
            // 일별 차트
            const dailyCtx = document.getElementById('dailyEmissionsChart').getContext('2d');
            dailyEmissionsChart = new Chart(dailyCtx, {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: '일별 탄소 배출량 (tCO₂eq)', 
                        data: [], 
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4, 
                        fill: true 
                    }] 
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true } 
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });

            // 월별 차트
            const monthlyCtx = document.getElementById('monthlyEmissionsChart').getContext('2d');
            monthlyEmissionsChart = new Chart(monthlyCtx, {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: '월별 탄소 배출량 (tCO₂eq)', 
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }] 
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true } 
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });

            // 일별 차량 연료별 탄소 배출량 차트 (실제 데이터 기반)
            const dailyFuelCtx = document.getElementById('dailyFuelEmissionsChart').getContext('2d');
            dailyFuelEmissionsChart = new Chart(dailyFuelCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [] // 동적으로 생성
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // app.py에 연료별 API를 추가하거나, 기존 API에서 연료별 정보를 받아오는 함수
        async function loadFuelData() {
            try {
                // 우선 app.py에 연료별 API가 있는지 확인
                const res = await fetch('/api/emissions/vehicle/by-fuel');
                if (res.ok) {
                    const fuelData = await res.json();
                    return fuelData;
                } else {
                    // 연료별 API가 없으면 기존 API 사용하되 연료별 차트는 표시하지 않음
                    return null;
                }
            } catch (err) {
                console.log('연료별 API가 없습니다. 연료별 차트는 표시되지 않습니다.');
                return null;
            }
        }

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'flex';
                const res = await fetch(`/api/emissions/vehicle`);
                if (!res.ok) throw new Error('데이터를 불러오는 중 오류가 발생했습니다.');
                const data = await res.json();

                updateCharts(data);
                updateSummary(data);

                // 연료별 데이터 로드 시도
                const fuelData = await loadFuelData();
                if (fuelData) {
                    updateDailyFuelChart(fuelData);
                } else {
                    // 연료별 데이터가 없으면 차트에 메시지 표시
                    showNoFuelDataMessage();
                }

            } catch (err) {
                document.getElementById('errorText').textContent = err.message;
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => document.getElementById('errorMessage').style.display = 'none', 5000);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // CSV 원본 데이터에서 차량수 계산
        async function loadVehicleCount() {
            try {
                const res = await fetch('/vehicle.csv');
                if (res.ok) {
                    const csvText = await res.text();
                    const lines = csvText.split('\n');
                    const headers = lines[0].split(',');
                    
                    let totalVehicles = 0;
                    let dailyVehicles = {};
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const date = values[0];
                            const vehicleCount = parseInt(values[5]) || 0;
                            
                            totalVehicles += vehicleCount;
                            
                            if (!dailyVehicles[date]) {
                                dailyVehicles[date] = 0;
                            }
                            dailyVehicles[date] += vehicleCount;
                        }
                    }
                    
                    const avgDailyVehicles = Math.round(totalVehicles / Object.keys(dailyVehicles).length);
                    document.getElementById('totalVehicles').textContent = `${avgDailyVehicles.toLocaleString()}대`;
                    
                    // 셔틀버스 배출량 고정값 설정
                    const shuttleEmissionsKg = 8740.59703;
                    const shuttleEmissionsTco2 = shuttleEmissionsKg / 1000;
                    document.getElementById('shuttleEmissions').textContent = `${shuttleEmissionsTco2.toFixed(2)} tCO₂eq/년`;
                }
            } catch (err) {
                console.log('차량수 데이터 로드 실패:', err);
                document.getElementById('totalVehicles').textContent = `-`;
                document.getElementById('shuttleEmissions').textContent = `8.74 tCO₂eq/년`;
            }
        }

        function updateCharts(data) {
            // 일별
            const dates = data.map(d => d['날짜']);
            const values = data.map(d => d['탄소배출량']);
            dailyEmissionsChart.data.labels = dates;
            dailyEmissionsChart.data.datasets[0].data = values;
            dailyEmissionsChart.update();

            // 월별
            const monthlyMap = {};
            data.forEach(d => {
                const m = d['날짜'].slice(0,7);
                monthlyMap[m] = (monthlyMap[m]||0) + d['탄소배출량'];
            });
            const months = Object.keys(monthlyMap).sort();
            const monthVals = months.map(m => monthlyMap[m]);
            monthlyEmissionsChart.data.labels = months;
            monthlyEmissionsChart.data.datasets[0].data = monthVals;
            monthlyEmissionsChart.update();
        }

        function updateDailyFuelChart(fuelData) {
            // 연료별 색상 정의
            const fuelColors = {
                '휘발유': '#ef4444',
                '경유': '#1f2937',
                'LPG': '#f59e0b',
                '하이브리드': '#60a5fa',
                '기타': '#94a3b8'
                // 전기와 수소는 배출량이 0이므로 자동으로 제외됨
            };

            // 날짜 추출
            const allDates = new Set();
            Object.values(fuelData).forEach(fuelArray => {
                fuelArray.forEach(item => allDates.add(item.날짜));
            });
            const dates = Array.from(allDates).sort();

            // 연료별 데이터셋 생성 (배출량이 0이 아닌 연료만)
            const datasets = [];
            Object.keys(fuelData).forEach(fuel => {
                // 해당 연료의 총 배출량 계산
                const totalEmission = fuelData[fuel].reduce((sum, item) => sum + item.탄소배출량, 0);
                
                // 배출량이 0보다 큰 연료만 차트에 추가
                if (totalEmission > 0) {
                    const data = dates.map(date => {
                        const item = fuelData[fuel].find(f => f.날짜 === date);
                        return item ? item.탄소배출량 : 0;
                    });

                    datasets.push({
                        label: fuel,
                        data: data,
                        backgroundColor: fuelColors[fuel] || '#94a3b8'
                    });
                }
            });

            dailyFuelEmissionsChart.data.labels = dates;
            dailyFuelEmissionsChart.data.datasets = datasets;
            dailyFuelEmissionsChart.update();
        }

        function showNoFuelDataMessage() {
            // 연료별 데이터가 없을 때 차트에 메시지 표시
            const canvas = document.getElementById('dailyFuelEmissionsChart');
            const ctx = canvas.getContext('2d');
            
            dailyFuelEmissionsChart.destroy();
            
            ctx.font = '16px Arial';
            ctx.fillStyle = '#6b7280';
            ctx.textAlign = 'center';
            ctx.fillText('연료별 상세 데이터가 제공되지 않습니다.', canvas.width / 2, canvas.height / 2 - 10);
            ctx.fillText('app.py에 /api/emissions/vehicle/by-fuel API 추가 필요', canvas.width / 2, canvas.height / 2 + 20);
        }

        function updateSummary(data) {
            // 평균 일간 배출량
            const total = data.reduce((s, d) => s + d['탄소배출량'], 0);
            const avgDaily = (data.length ? total / data.length : 0).toFixed(2);
            document.getElementById('dailyEmissions').textContent = `${avgDaily} tCO₂eq`;

            // 총 월간 배출량
            document.getElementById('monthlyEmissions').textContent = `${total.toFixed(2)} tCO₂eq`;

            // 하드코딩 값들
            document.getElementById('totalVehicles').textContent = `97034대`;
            document.getElementById('shuttleEmissions').textContent = `8.74 tCO₂eq/년`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadData();
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            document.getElementById('yearSelector').addEventListener('change', loadData);
        });
    </script>
</body>
</html>